$(document).ready(function(){window.spectrum={};var c=e("publications");var i=e("mediaBias");var d="http://spectrum-backend.herokuapp.com/feeds/publications";var k="http://spectrum-backend.herokuapp.com/feeds/test_api";var b=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];function e(m){var o=localStorage.getItem("spectrum-"+m);if(!o){return undefined}o=JSON.parse(o);var n=1000*60*24*7;if(new Date()-new Date(o.dateSaved)<n){return o.data}return null}function j(n,o){var m={dateSaved:new Date().toString(),data:o,};localStorage.setItem("spectrum-"+n,JSON.stringify(m))}window.spectrum.getLocalStorage=e;window.spectrum.setLocalStorage=j;function g(n){var m={};n.forEach(function(o){if(!o.fields.skip_scaping){m[o.fields.base_url]=o}});return m}function h(o,n,m,p){console.log(o);console.log("req",n);console.log("textstatus",m);console.log("errorthrown",p)}function a(m,o,q,p){m=chrome.extension.getURL(m);o=o||{};var n;$.ajax({url:m,type:"GET",}).fail(function(s,r,t){h("Failed to get template: "+m,s,r,t)}).done(function(s){var r=Handlebars.compile(s);if(p){o.forEach(function(t,u){n=r(t);q[u]($(n))})}else{n=r(o);q($(n))}})}var f={init:function(m){this._hidden=e("hidden");if(this._hidden!=="spectrum-close"&&c[m.host]){this.getAssociations(2)}},getAssociations:function(m){var n=this;$.ajax({url:k,type:"GET",}).fail(function(p,o,q){h("Failed to get associations",p,o,q)}).done(function(o){n.showArticles(o,c[location.host],m)})},_showContainer:function(){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")},_hideContainer:function(o){var q=this._$container.find("#spectrum-current-publication-icon");var r;var n=o==="spectrum-minimize";var p=n?"spectrum-close":"spectrum-minimize";var m=c[location.host].fields.bias;p+=" spectrum-not-minimize";if(n&&!q.attr("src")){r=chrome.extension.getURL("../images/icon-"+m+".png");q.attr("src",r)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(o);this._$container.removeClass(p)},showArticles:function(n,o,m){a("../html/main.html",undefined,function(p){this._addContainerCb(p,n,o,m)}.bind(this))},_addContainerCb:function(m,o,p,n){var q=p.fields;this._$container=m;this._$articlesContainer=m.find("#spectrum-articles-container");this._$articleBorder=m.find("#spectrum-articles-container-top-border");$("body").append(m);if(this._hidden){this._hideContainer(this._hidden)}a("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+q.bias+".png"),bias:i[q.bias],target_url:q.base_url,publication:q.name,},function(r){this._addCurrArticleCB(r,o,n)}.bind(this))},_addCurrArticleCB:function(m,q,o){var s,n,r;var t=function(u){this._$articlesContainer.append(u)}.bind(this);if(o<=2||!q.length){this._$articlesContainer.append(m)}if(q.length){var p=function(u){this._$articlesContainer.append(u)}.bind(this);r=true;n=[];t=[];s="../html/article.html";q.forEach(function(w){if(n.length>=o){return}var v="More From the "+i[w.publication_bias]+" Â»";var u=new Date(w.publication_date);n.push({imageUrl:w.image_url,source:w.publication_name,headLine:w.title,target_url:w.url,more_text:v,bias:w.publication_bias,publication_date:b[u.getMonth()]+" "+u.getDate(),});t.push(p)})}else{s="../html/unknown.html";n={imageUrl:chrome.extension.getURL("../images/unknown.png"),}}a(s,n,t,r);this._$container.on("click",".spectrum-more-link a",function(){this.getAssociations(3)}.bind(this));this._$container.on("click",".spectrum-hide-panel",function(v){var u=v.target.dataset.hideType;j("hidden",u);this._hideContainer(u)}.bind(this));this._$container.on("click",".spectrum-expand-icon",function(){j("hidden",null);this._showContainer()}.bind(this))},};function l(){var m=window.location;f.init(m)}if(c&&i){l()}else{$.ajax({url:d,type:"GET",}).fail(function(n,m,o){h("Failed to get publications and media biases",n,m,o)}).done(function(m){c=g(m.publications);i=m.media_bias;j("publications",c);j("mediaBias",i);l()})}});