var clickURL="https://spectrum-backend.herokuapp.com/feeds/click";var feedbackURL="https://spectrum-backend.herokuapp.com/feeds/feedback";var currentVersion=chrome.runtime.getManifest().version;var unique_id;function getRandomToken(){var a=new Uint8Array(32);crypto.getRandomValues(a);var c="";for(var b=0;b<a.length;++b){c+=a[b].toString(16)}return c}function setOrGetUniqueId(a,c){var b=c&&c.toLowerCase().indexOf("test")>=0;if(!unique_id){chrome.storage.sync.get(["unique_id","username"],function(d){unique_id=d.unique_id;var e=d.unique_id;if(!unique_id){unique_id=e+"-"+getRandomToken();chrome.storage.sync.set({unique_id:unique_id,})}a({unique_id:unique_id,is_internal_user:b,});return true});return true}else{a({unique_id:unique_id,is_internal_user:b,});return true}}function processValue(d,e){if(!d){return undefined}if(!d||!d.dateSaved){return d}var c=1000*60*60*24*7;var a=true;var b=new Date(d.dateSaved);if(e){a=new Date(e)<b}if(a&&new Date()-b<c){return d.data}return d.data}function getLocalStorage(b,a,c){chrome.storage.sync.get(b,function(d){for(var e in d){if(d.hasOwnProperty(e)){d[e]=processValue(d[e],c)}}if(a){a(d);return true}else{return true}});return true}function setLocalStorage(d,b,e){var a={};for(var c in d){if(d.hasOwnProperty(c)){if(e){a[c]={dateSaved:new Date().toString(),data:d[c],}}else{a[c]=d[c]}}}chrome.storage.sync.set(a,function(f){if(b){b(f);return true}return true});return true}chrome.runtime.onMessage.addListener(function(e,d,a){if(e.action==="setIcon"){var c=chrome.extension.getURL(e.url);chrome.browserAction.setIcon({path:c});return true}else{if(e.action==="processValue"){var b=processValue(e.keyData,e.earliestAcceptableDate);a(b);return true}else{if(e.action==="getLocalStorage"){if(e.localValues.indexOf("username")===-1){e.localValues.push("username")}getLocalStorage(e.localValues,function(f){setOrGetUniqueId(function(g){f.unique_id=g.unique_id;f.is_internal_user=g.is_internal_user;a(f);return true},f.username);return true},e._earliestAcceptableDate);return true}else{if(e.action==="setLocalStorage"){setLocalStorage(e.localValues,undefined,e.checkDate);return true}else{if(e.action==="sendClick"||e.action==="sendFeedback"){getLocalStorage(["username"],function(f){setOrGetUniqueId(function(g){var h=g.unique_id;var i=g.is_internal_user;var j=e.action==="sendClick"?clickURL:feedbackURL;var k=e.dataParam;k.clicked_version=currentVersion;k.unique_id=h;k.username=f.username;k.is_internal_user=i;$.ajax({url:j,data:k,type:"POST",}).fail(function(m,l,n){console.log("Failed to save click");console.log("req",m);console.log("textstatus",l);console.log("errorthrown",n)}).done(function(){console.log("Successfully saved click")})},f.username);return true});return true}else{if(e.action==="setOrGetUniqueId"){setOrGetUniqueId(a,e.username);return true}}}}}}});