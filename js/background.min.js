var clickURL="https://spectrum-backend.herokuapp.com/feeds/click";var feedbackURL="https://spectrum-backend.herokuapp.com/feeds/feedback";var currentVersion=chrome.runtime.getManifest().version;var unique_id;function getRandomToken(){var a=new Uint8Array(32);crypto.getRandomValues(a);var c="";for(var b=0;b<a.length;++b){c+=a[b].toString(16)}return c}function processValue(d,e){if(!d){return undefined}if(!d||!d.dateSaved){return d}var c=1000*60*60*24*7;var a=true;var b=new Date(d.dateSaved);if(e){a=new Date(e)<b}if(a&&new Date()-b<c){return d.data}return d.data}function getLocalStorage(b,a,c){chrome.storage.sync.get(b,function(d){for(var e in d){if(d.hasOwnProperty(e)){d[e]=processValue(d[e],c)}}if(a){return a(d)}else{return true}})}function setLocalStorage(d,b,e){var a={};for(var c in d){if(d.hasOwnProperty(c)){if(e){a[c]={dateSaved:new Date().toString(),data:d[c],}}else{a[c]=d[c]}}}chrome.storage.sync.set(a,function(){if(b){b()}return true})}chrome.runtime.onMessage.addListener(function(e,d,a){if(e.action==="setIcon"){var c=chrome.extension.getURL(e.url);chrome.browserAction.setIcon({path:c});return true}else{if(e.action==="processValue"){var b=processValue(e.keyData,e.earliestAcceptableDate);a(b);return true}else{if(e.action==="getLocalStorage"){getLocalStorage(e.localValues,function(f){a(f);return true},e._earliestAcceptableDate);return true}else{if(e.action==="setLocalStorage"){setLocalStorage(e.localValues,function(f){a(f);return true},e.checkDate);return true}else{if(e.action==="sendClick"||e.action==="sendFeedback"){chrome.runtime.sendMessage({action:"setOrGetUniqueId",},function(f){var g=e.action==="sendClick"?clickURL:feedbackURL;var h=e.dataParam;h.clicked_version=currentVersion;h.unique_id=f;$.ajax({url:g,data:h,type:"POST",}).fail(function(j,i,k){console.log("Failed to save click");console.log("req",j);console.log("textstatus",i);console.log("errorthrown",k)}).done(function(){console.log("Successfully saved click")})});return true}else{if(e.action==="setOrGetUniqueId"){if(!unique_id){chrome.storage.sync.get(["unique_id","username"],function(f){unique_id=f.unique_id;var g=f.unique_id;if(!unique_id){unique_id=g+"-"+getRandomToken();chrome.storage.sync.set({unique_id:unique_id,})}a(unique_id);return true})}else{a(unique_id);return true}}}}}}}});