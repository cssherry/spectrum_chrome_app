var publications=getLocalStorage("publications");var mediaBias=getLocalStorage("mediaBias");var associationApiUrl="http://spectrum-backend.herokuapp.com/feeds/test_api";var monthNames=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];function getLocalStorage(a){var c=localStorage.getItem("spectrum-"+a);if(!c){return undefined}c=JSON.parse(c);var b=1000*60*24*7;if(new Date()-new Date(c.dateSaved)<b){return c.data}return null}function setLocalStorage(b,c){var a={dateSaved:new Date().toString(),data:c,};localStorage.setItem("spectrum-"+b,JSON.stringify(a))}function logError(c,b,a,d){console.log(c);console.log("req",b);console.log("textstatus",a);console.log("errorthrown",d)}function render(a,c,e,d){a=chrome.extension.getURL(a);c=c||{};var b;$.ajax({url:a,type:"GET",}).fail(function(g,f,h){logError("Failed to get template: "+a,g,f,h)}).done(function(g){var f=Handlebars.compile(g);if(d){c.forEach(function(h,j){b=f(h);e[j]($(b))})}else{b=f(c);e($(b))}})}var spectrum={init:function(a){var b=getLocalStorage("hidden")!=="spectrum-close";this.currentPublication=publications[a.host];if(b&&this.currentPublication){this.getAssociations(2)}return this},getAssociations:function(a){var b=this;$.ajax({url:associationApiUrl,type:"GET",}).fail(function(d,c,e){logError("Failed to get associations",d,c,e)}).done(function(c){if(b._$container){b._addContainerCb(undefined,c,publications[location.host],a)}else{b.showArticles(c,publications[location.host],a)}})},_hideIcon:function(){this._$container.addClass("spectrum-no-button")},_showIcon:function(){this._$container.removeClass("spectrum-no-button")},_showContainer:function(){if(this._$articleBorder){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")}},_hideContainer:function(d){var c=this._$container.find("#spectrum-current-publication-icon");var f;var b=d==="spectrum-minimize";var e=b?"spectrum-close":"spectrum-minimize";var a=publications[location.host].fields.bias;e+=" spectrum-not-minimize";if(b&&!c.attr("src")){f=chrome.extension.getURL("../images/icon-"+a+".png");c.attr("src",f)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(d);this._$container.removeClass(e)},showArticles:function(b,a){render("../html/main.html",undefined,function(c){this._addContainerCb(c,b,a)}.bind(this))},_addContainerCb:function(a,c,b){var e=this.currentPublication.fields;if(a){this._$container=a;this._$articlesContainer=a.find("#spectrum-articles-container");this._$articleBorder=a.find("#spectrum-articles-container-top-border");$("body").append(a);this._$container.on("click.spectrumReload",".spectrum-more-link a",function(){this.getAssociations(3)}.bind(this));this._$container.on("click.spectrumHide",".spectrum-hide-panel",function(g){var f=g.target.dataset.hideType;setLocalStorage("hidden",f);this._hideContainer(f)}.bind(this));this._$container.on("click.spectrumExpand",".spectrum-expand-icon",function(){setLocalStorage("hidden",null);this._showContainer()}.bind(this))}else{this._$articlesContainer.empty()}var d=getLocalStorage("hidden");if(d){this._hideContainer(d)}if(getLocalStorage("hiddenIcon")){this._hideIcon()}render("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+e.bias+".png"),bias:mediaBias[e.bias],target_url:e.base_url,publication:e.name,},function(f){this._addCurrArticleCB(f,c,b)}.bind(this))},_addCurrArticleCB:function(a,e,c){var g,b,f;var h=function(i){this._$articlesContainer.append(i)}.bind(this);if(c<=2||!e.length){this._$articlesContainer.append(a)}if(e.length){var d=function(i){this._$articlesContainer.append(i)}.bind(this);f=true;b=[];h=[];g="../html/article.html";e.forEach(function(k){if(b.length>=c){return}var j="More From the "+mediaBias[k.publication_bias]+" Â»";var i=new Date(k.publication_date);b.push({imageUrl:k.image_url,source:k.publication_name,headLine:k.title,target_url:k.url,more_text:j,bias:k.publication_bias,publication_date:monthNames[i.getMonth()]+" "+i.getDate(),});h.push(d)})}else{g="../html/unknown.html";b={imageUrl:chrome.extension.getURL("../images/unknown.png"),}}render(g,b,h,f)},};