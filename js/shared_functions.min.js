var associationApiUrl="https://spectrum-backend.herokuapp.com/feeds/associations";var unique_id;var monthNames=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];function cleanUrl(a){return a.split(".").slice(-2).join(".")}function logError(c,b,a,d){console.log(c);console.log("req",b);console.log("textstatus",a);console.log("errorthrown",d)}function render(a,c,e,d){a=chrome.extension.getURL(a);c=c||{};var b;$.ajax({url:a,type:"GET",}).fail(function(g,f,h){logError("Failed to get template: "+a,g,f,h)}).done(function(g){var f=Handlebars.compile(g);if(d){c.forEach(function(h,j){b=f(h);e[j]($(b))})}else{b=f(c);e($(b))}})}var spectrum={init:function(a,c,b){var d=this;d.location=a;d.publications=c;d.mediaBias=b;chrome.runtime.sendMessage({action:"getLocalStorage",localValues:["hidden","hiddenIcon","username"],},function(e){d.isNotClosed=e.hidden!=="spectrum-close";unique_id=e.unique_id;d.username=e.username;d.is_internal_user=e.is_internal_user;d.hidden=e.hidden;d.hiddenIcon=e.hiddenIcon;if(d.isNotClosed){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",})}else{chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",})}var f=cleanUrl(a.hostname);var g=a.origin+"/"===a.href||a.origin===a.href;d.currentPublication=d.publications[f];if(d.currentPublication&&!g){d.getAssociations()}});return this},getAssociations:function(){var b=this;b.currentURL=location.href.split("?")[0];var a={url:b.currentURL,unique_id:unique_id,username:b.username,is_internal_user:b.is_internal_user,};$.ajax({url:associationApiUrl,data:a,type:"POST",}).fail(function(d,c,e){logError("Failed to get associations",d,c,e)}).done(function(c){b.currentArticle=c;if(c){if(b.isNotClosed){if(b._$container){b._addContainerCb(undefined,c)}else{b.showArticles(c)}}}})},_hideIcon:function(){this._$container.addClass("spectrum-no-button")},_showIcon:function(){this._$container.removeClass("spectrum-no-button")},_showContainer:function(){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",});this.isNotClosed=true;if(this._$articleBorder){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")}},_hideContainer:function(d){var c=this._$container.find("#spectrum-current-publication-icon");var f;var b=d==="spectrum-minimize";var e=b?"spectrum-close":"spectrum-minimize";var a=this.currentPublication.fields.bias;e+=" spectrum-not-minimize";if(d==="spectrum-close"){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",});this.isNotClosed=false}if(b&&!c.attr("src")){f=chrome.extension.getURL("../images/icon-"+a+".png");c.attr("src",f)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(d);this._$container.removeClass(e)},showArticles:function(a){render("../html/main.html",undefined,function(b){this._addContainerCb(b,a)}.bind(this))},_addContainerCb:function(a,b){var d=this.currentPublication.fields;var f=this;var e=f.hidden;var c=f.hiddenIcon;if(a){f._$container=a;f._$articlesContainer=a.find("#spectrum-articles-container");f._$articleBorder=a.find("#spectrum-articles-container-top-border");$("body").append(a);if(e===null){f._showContainer()}else{f._hideContainer("spectrum-minimize")}f._$container.on("click.spectrumHide",".spectrum-hide-panel",function(h){var g=h.target.dataset.hideType;chrome.runtime.sendMessage({action:"setLocalStorage",localValues:{hidden:g},});f._hideContainer(g)});f._$container.on("click.spectrumExpand",".spectrum-expand-icon",function(){chrome.runtime.sendMessage({action:"setLocalStorage",localValues:{hidden:null},});f._showContainer()});f._$container.on("click.sendClick",function(i){var h;i.stopPropagation();if(i.target.id){h="#"+i.target.id}else{h="."+i.target.className.replace(/ /g,".")}var g={element_selector:h,clicked_item_dict:JSON.stringify({element_id:i.target.id,element_class:i.target.className,element_data:i.target.dataset,element_text:i.target.textContent,}),};chrome.runtime.sendMessage({action:"sendClick",dataParam:g,})})}else{f._$articlesContainer.empty()}if(e){f._hideContainer(e)}else{f._showContainer()}if(c){f._hideIcon()}render("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+d.bias+".png"),bias:f.mediaBias[d.bias],biasAbbr:d.bias,target_url:d.base_url,publication:d.name,},function(g){f._addCurrArticleCB(g,b)})},_addCurrArticleCB:function(h,l){var a,c,f;var i=this;var j=function(o){i._$articlesContainer.append(o)};i._$articlesContainer.append(h);if(l.length){var k=function(o){i._$articlesContainer.append(o);$(window).trigger("resize.show-or-hide")};f=true;c=[];j=[];a="../html/article.html";var m=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-prev">');m.append('<span class="spectrum-icon-prev" aria-hidden="true"></span>');var g=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-next">');g.append('<span class="spectrum-icon-next" aria-hidden="true"></span>');i._$articlesContainer.append(m);m.hide();i._$articlesContainer.append(g);l.forEach(function(q){var o=i.mediaBias[q.publication_bias];var r=new Date(q.publication_date);var p=q.image_url||q.publication_logo;if(location.host==="www.nytimes.com"){p=q.publication_logo.replace(/^http:/,"https:")}c.push({imageUrl:p,source:q.publication_name,headLine:q.title,target_url:q.url,more_text:o,bias:q.publication_bias,publication_date:monthNames[r.getMonth()]+" "+r.getDate(),});j.push(k)});var b;$(window).off("resize.show-or-hide").on("resize.show-or-hide",function(){n();setTimeout(function(){if(b){var r,t=0,s=0;var o=b.filter(function(){var w=e(this);var v=$(this).is(":visible");if(r===undefined&&v&&w){r=d(this)}if(!w&&v){t++}if(w&&v){s++}return !v});if(t){g.show()}else{g.hide()}if(s<r){var q=r-s;var u=o.length;for(var p=u;p>u-q;p--){$(o[p-1]).show()}if(u===q){m.hide()}}}},100)});this._$articlesContainer.off("click.show-or-hide").on("click.show-or-hide","a.spectrum-carousel-control",function(u){var p=$(u.currentTarget),o=p.hasClass("spectrum-carousel-prev"),t,q;n();var s=b.filter(function(){var x=e(this);var w=!$(this).is(":visible");if(x&&!w&&!t){t=d(this)}if(o){if(w){if(q===undefined){q=1}else{q++}}return w}if(x){q=0}else{if($.isNumeric(q)){q++}}return x});if(q<=t){p.hide()}if(o){var v=s.length;for(var r=v;r>v-t;r--){$(s[r-1]).show()}g.show()}else{s.hide();m.show()}});function n(){if(!b){var o=i._$articlesContainer.find(".spectrum-article-container");if(l.length===o.length){b=o}}}function e(o){if(typeof jQuery==="function"&&o instanceof jQuery){o=o[0]}var p=o.getBoundingClientRect();return(p.top>=0&&p.left>=0&&p.top<=(window.innerHeight||document.documentElement.clientHeight)&&p.left<=(window.innerWidth||document.documentElement.clientWidth))}function d(o){return Math.floor((o.parentElement.clientWidth-170)/o.clientWidth)}}else{a="../html/unknown.html";c={imageUrl:chrome.extension.getURL("../images/unknown.png"),currentURL:i.currentURL,location:encodeURIComponent(i.location.href),currentVersion:chrome.runtime.getManifest().version,}}render(a,c,j,f)},};