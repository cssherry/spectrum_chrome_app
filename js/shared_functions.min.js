var associationApiUrl="https://spectrum-backend.herokuapp.com/feeds/associations";var monthNames=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];function getLocalStorage(c,f){var e=localStorage.getItem("spectrum-"+c);if(!e){return undefined}e=JSON.parse(e);var d=1000*60*24*7;var a=true;var b=new Date(e.dateSaved);if(f){a=new Date(f)<b}if(a&&new Date()-b<d){return e.data}return null}function setLocalStorage(b,c){var a={dateSaved:new Date().toString(),data:c,};localStorage.setItem("spectrum-"+b,JSON.stringify(a))}function cleanUrl(a){return a.split(".").slice(-2).join(".")}function logError(c,b,a,d){console.log(c);console.log("req",b);console.log("textstatus",a);console.log("errorthrown",d)}function render(a,c,e,d){a=chrome.extension.getURL(a);c=c||{};var b;$.ajax({url:a,type:"GET",}).fail(function(g,f,h){logError("Failed to get template: "+a,g,f,h)}).done(function(g){var f=Handlebars.compile(g);if(d){c.forEach(function(h,j){b=f(h);e[j]($(b))})}else{b=f(c);e($(b))}})}var spectrum={init:function(a){this.publications=getLocalStorage("publications","March 25, 2017");this.mediaBias=getLocalStorage("mediaBias");var b=cleanUrl(a.hostname);var c=a.origin+"/"===a.href||a.origin===a.href;this.currentPublication=this.publications[b];if(this.currentPublication&&!c){this.getAssociations()}return this},getAssociations:function(){var b=this;var a=encodeURIComponent(location.href.split("?")[0]);$.ajax({url:associationApiUrl+"?url="+a,type:"GET",}).fail(function(d,c,e){logError("Failed to get associations",d,c,e)}).done(function(d){b.currentArticle=d;if(d){var c=getLocalStorage("hidden")!=="spectrum-close";if(c){if(b._$container){b._addContainerCb(undefined,d)}else{b.showArticles(d)}}}})},_hideIcon:function(){this._$container.addClass("spectrum-no-button")},_showIcon:function(){this._$container.removeClass("spectrum-no-button")},_showContainer:function(){if(this._$articleBorder){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")}},_hideContainer:function(d){var c=this._$container.find("#spectrum-current-publication-icon");var f;var b=d==="spectrum-minimize";var e=b?"spectrum-close":"spectrum-minimize";var a=this.currentPublication.fields.bias;e+=" spectrum-not-minimize";if(b&&!c.attr("src")){f=chrome.extension.getURL("../images/icon-"+a+".png");c.attr("src",f)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(d);this._$container.removeClass(e)},showArticles:function(a){render("../html/main.html",undefined,function(b){this._addContainerCb(b,a)}.bind(this))},_addContainerCb:function(a,b){var d=this.currentPublication.fields;if(a){this._$container=a;this._$articlesContainer=a.find("#spectrum-articles-container");this._$articleBorder=a.find("#spectrum-articles-container-top-border");$("body").append(a);if(getLocalStorage("hidden")===null){this._showContainer()}else{this._hideContainer("spectrum-minimize")}this._$container.on("click.spectrumHide",".spectrum-hide-panel",function(g){var f=g.target.dataset.hideType;setLocalStorage("hidden",f);this._hideContainer(f)}.bind(this));this._$container.on("click.spectrumExpand",".spectrum-expand-icon",function(){setLocalStorage("hidden",null);this._showContainer()}.bind(this))}else{this._$articlesContainer.empty()}var c=getLocalStorage("hidden");if(c){this._hideContainer(c)}if(getLocalStorage("hiddenIcon")){this._hideIcon()}render("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+d.bias+".png"),bias:this.mediaBias[d.bias],biasAbbr:d.bias,target_url:d.base_url,publication:d.name,},function(e){this._addCurrArticleCB(e,b)}.bind(this))},_addCurrArticleCB:function(h,l){var a,c,f;var i=this;var j=function(o){this._$articlesContainer.append(o)}.bind(this);this._$articlesContainer.append(h);if(l.length){var k=function(o){this._$articlesContainer.append(o);$(window).trigger("resize.show-or-hide")}.bind(this);f=true;c=[];j=[];a="../html/article.html";var m=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-prev">');m.append('<span class="spectrum-icon-prev" aria-hidden="true"></span>');m.append('<span class="sr-only">Previous</span>');var g=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-next">');g.append('<span class="spectrum-icon-next" aria-hidden="true"></span>');g.append('<span class="sr-only">Next</span>');this._$articlesContainer.append(m);m.hide();this._$articlesContainer.append(g);l.forEach(function(q){var o=this.mediaBias[q.publication_bias];var r=new Date(q.publication_date);var p=q.image_url||q.publication_logo;if(location.host==="www.nytimes.com"){p=q.publication_logo}c.push({imageUrl:p,source:q.publication_name,headLine:q.title,target_url:q.url,more_text:o,bias:q.publication_bias,publication_date:monthNames[r.getMonth()]+" "+r.getDate(),});j.push(k)}.bind(this));var b;$(window).off("resize.show-or-hide").on("resize.show-or-hide",function(){n();setTimeout(function(){if(b){var r,t=0,s=0;var o=b.filter(function(){var w=e(this);var v=$(this).is(":visible");if(r===undefined&&v&&w){r=d(this)}if(!w&&v){t++}if(w&&v){s++}return !v});if(t){g.show()}else{g.hide()}if(s<r){var q=r-s;var u=o.length;for(var p=u;p>u-q;p--){$(o[p-1]).show()}if(u===q){m.hide()}}}},100)});this._$articlesContainer.off("click.show-or-hide").on("click.show-or-hide","a.spectrum-carousel-control",function(u){var o=$(u.currentTarget),r=o.hasClass("spectrum-carousel-prev"),t,p;n();var s=b.filter(function(){var x=e(this);var w=!$(this).is(":visible");if(x&&!w&&!t){t=d(this)}if(r){if(w){if(p===undefined){p=1}else{p++}}return w}else{if(x){p=0}else{if($.isNumeric(p)){p++}}return x}});if(p<=t){o.hide()}if(r){var v=s.length;for(var q=v;q>v-t;q--){$(s[q-1]).show()}g.show()}else{s.hide();m.show()}});function n(){if(!b){var o=i._$articlesContainer.find(".spectrum-article-container");if(l.length===o.length){b=o}}}function e(o){if(typeof jQuery==="function"&&o instanceof jQuery){o=o[0]}var p=o.getBoundingClientRect();return(p.top>=0&&p.left>=0&&p.top<=(window.innerHeight||document.documentElement.clientHeight)&&p.left<=(window.innerWidth||document.documentElement.clientWidth))}function d(o){return Math.floor((o.parentElement.clientWidth-170)/o.clientWidth)}}else{a="../html/unknown.html";c={imageUrl:chrome.extension.getURL("../images/unknown.png"),}}render(a,c,j,f)},};