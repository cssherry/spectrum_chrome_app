var associationApiUrl="https://spectrum-backend.herokuapp.com/feeds/associations";var monthNames=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];var numOfArticlesToShow=3;function getLocalStorage(c,f){var e=localStorage.getItem("spectrum-"+c);if(!e){return undefined}e=JSON.parse(e);var d=1000*60*24*7;var a=true;var b=new Date(e.dateSaved);if(f){a=new Date(f)<b}if(a&&new Date()-b<d){return e.data}return null}function setLocalStorage(b,c){var a={dateSaved:new Date().toString(),data:c,};localStorage.setItem("spectrum-"+b,JSON.stringify(a))}function cleanUrl(a){return a.split(".").slice(-2).join(".")}function logError(c,b,a,d){console.log(c);console.log("req",b);console.log("textstatus",a);console.log("errorthrown",d)}function render(a,c,e,d){a=chrome.extension.getURL(a);c=c||{};var b;$.ajax({url:a,type:"GET",}).fail(function(g,f,h){logError("Failed to get template: "+a,g,f,h)}).done(function(g){var f=Handlebars.compile(g);if(d){c.forEach(function(h,j){b=f(h);e[j]($(b))})}else{b=f(c);e($(b))}})}var spectrum={init:function(a){this.publications=getLocalStorage("publications","March 25, 2017");this.mediaBias=getLocalStorage("mediaBias");var b=getLocalStorage("hidden")!=="spectrum-close";var c=cleanUrl(a.hostname);this.currentPublication=this.publications[c];if(b&&this.currentPublication){this.getAssociations(numOfArticlesToShow)}return this},getAssociations:function(a){var c=this;var b=encodeURIComponent(location.href.split("?")[0]);$.ajax({url:associationApiUrl+"?url="+b,type:"GET",}).fail(function(e,d,f){logError("Failed to get associations",e,d,f)}).done(function(d){if(d){if(c._$container){c._addContainerCb(undefined,d,a)}else{c.showArticles(d,a)}}})},_hideIcon:function(){this._$container.addClass("spectrum-no-button")},_showIcon:function(){this._$container.removeClass("spectrum-no-button")},_showContainer:function(){if(this._$articleBorder){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")}},_hideContainer:function(d){var c=this._$container.find("#spectrum-current-publication-icon");var f;var b=d==="spectrum-minimize";var e=b?"spectrum-close":"spectrum-minimize";var a=this.currentPublication.fields.bias;e+=" spectrum-not-minimize";if(b&&!c.attr("src")){f=chrome.extension.getURL("../images/icon-"+a+".png");c.attr("src",f)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(d);this._$container.removeClass(e)},showArticles:function(b,a){render("../html/main.html",undefined,function(c){this._addContainerCb(c,b,a)}.bind(this))},_addContainerCb:function(a,c,b){var e=this.currentPublication.fields;if(a){this._$container=a;this._$articlesContainer=a.find("#spectrum-articles-container");this._$articleBorder=a.find("#spectrum-articles-container-top-border");$("body").append(a);if(getLocalStorage("hidden")===null){this._showContainer()}else{this._hideContainer("spectrum-minimize")}this._$container.on("click.spectrumReload",".spectrum-more-link a",function(){this.getAssociations(3)}.bind(this));this._$container.on("click.spectrumHide",".spectrum-hide-panel",function(g){var f=g.target.dataset.hideType;setLocalStorage("hidden",f);this._hideContainer(f)}.bind(this));this._$container.on("click.spectrumExpand",".spectrum-expand-icon",function(){setLocalStorage("hidden",null);this._showContainer()}.bind(this))}else{this._$articlesContainer.empty()}var d=getLocalStorage("hidden");if(d){this._hideContainer(d)}if(getLocalStorage("hiddenIcon")){this._hideIcon()}render("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+e.bias+".png"),bias:this.mediaBias[e.bias],biasAbbr:e.bias,target_url:e.base_url,publication:e.name,},function(f){this._addCurrArticleCB(f,c,b)}.bind(this))},_addCurrArticleCB:function(e,d,b){var g,a,f;var h=function(i){this._$articlesContainer.append(i)}.bind(this);this._$articlesContainer.append(e);if(d.length){var c=function(i){this._$articlesContainer.append(i)}.bind(this);f=true;a=[];h=[];g="../html/article.html";d.forEach(function(k){if(a.length>=b){return}var i="More "+this.mediaBias[k.publication_bias]+" Articles Â»";var l=new Date(k.publication_date);var j=k.image_url||k.publication_logo;if(location.host==="www.nytimes.com"){j=k.publication_logo}a.push({imageUrl:j,source:k.publication_name,headLine:k.title,target_url:k.url,more_text:i,bias:k.publication_bias,publication_date:monthNames[l.getMonth()]+" "+l.getDate(),});h.push(c)}.bind(this))}else{g="../html/unknown.html";a={imageUrl:chrome.extension.getURL("../images/unknown.png"),}}render(g,a,h,f)},};