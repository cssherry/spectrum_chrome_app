var associationApiUrl="https://spectrum-backend.herokuapp.com/feeds/associations";var currentVersion=chrome.runtime.getManifest().version;var unique_id;var monthNames=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];function cleanUrl(a){return a.split(".").slice(-2).join(".")}function logError(c,b,a,d){console.log(c);console.log("req",b);console.log("textstatus",a);console.log("errorthrown",d)}function render(a,c,e,d){a=chrome.extension.getURL(a);c=c||{};var b;$.ajax({url:a,type:"GET",}).fail(function(g,f,h){logError("Failed to get template: "+a,g,f,h)}).done(function(g){var f=Handlebars.compile(g);if(d){c.forEach(function(h,j){b=f(h);e[j]($(b))})}else{b=f(c);e($(b))}})}var spectrum={init:function(a,d,c,b){var e=this;e.location=a;e.publications=d;e.mediaBias=c;e.spectrumModal=b;chrome.runtime.sendMessage({action:"getLocalStorage",localValues:["hidden","hiddenIcon","username"],},function(f){e.isNotClosed=f.hidden!=="spectrum-close";unique_id=f.unique_id;e.username=f.username;e.is_internal_user=f.is_internal_user;e.hidden=f.hidden;e.hiddenIcon=f.hiddenIcon;e.spectrumModal.setValue("unique_id",unique_id);e.spectrumModal.setValue("feedback_version",currentVersion);e.spectrumModal.setValue("username",e.username);e.spectrumModal.setValue("is_internal_user",e.is_internal_user);if(e.isNotClosed){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",})}else{chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",})}var g=cleanUrl(a.hostname);var h=a.origin+"/"===a.href||a.origin===a.href;e.currentPublication=e.publications[g];if(e.currentPublication&&!h){e.getAssociations()}});return this},getAssociations:function(){var b=this;b.currentURL=location.href.split("?")[0];b.spectrumModal.setValue("currentURL",b.currentURL);b.spectrumModal.setValue("fullURL",location.href);var a={url:b.currentURL,unique_id:unique_id,username:b.username,is_internal_user:b.is_internal_user,};$.ajax({url:associationApiUrl,data:a,type:"POST",}).fail(function(d,c,e){logError("Failed to get associations",d,c,e)}).done(function(c){b.associatedArticles=c.top_associations;b.currentArticle=c.current_article;if(c){if(b.isNotClosed){if(b._$container){b._addContainerCb(undefined)}else{b.showArticles()}}}})},_hideIcon:function(){this._$container.addClass("spectrum-no-button")},_showIcon:function(){this._$container.removeClass("spectrum-no-button")},_showContainer:function(){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",});this.isNotClosed=true;if(this._$articleBorder){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")}},_hideContainer:function(d){var c=this._$container.find("#spectrum-current-publication-icon");var f;var b=d==="spectrum-minimize";var e=b?"spectrum-close":"spectrum-minimize";var a=this.currentPublication.fields.bias;e+=" spectrum-not-minimize";if(d==="spectrum-close"){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",});this.isNotClosed=false}if(b&&!c.attr("src")){f=chrome.extension.getURL("../images/icon-"+a+".png");c.attr("src",f)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(d);this._$container.removeClass(e)},showArticles:function(){render("../html/main.html",undefined,function(a){this._addContainerCb(a)}.bind(this))},_addContainerCb:function(a){var c=this.currentPublication.fields;var e=this;var d=e.hidden;var b=e.hiddenIcon;if(a){e._$container=a;e._$articlesContainer=a.find("#spectrum-articles-container");e._$articleBorder=a.find("#spectrum-articles-container-top-border");$("body").append(a);if(d===null){e._showContainer()}else{e._hideContainer("spectrum-minimize")}e.spectrumModal.trigger(e._$container);e._$container.on("click.spectrumHide",".spectrum-hide-panel",function(g){var f=g.target.dataset.hideType;chrome.runtime.sendMessage({action:"setLocalStorage",localValues:{hidden:f},});e._hideContainer(f)});e._$container.on("click.spectrumExpand",".spectrum-expand-icon",function(){chrome.runtime.sendMessage({action:"setLocalStorage",localValues:{hidden:null},});e._showContainer()});e._$container.on("click.sendClick",function(h){var g;h.stopPropagation();if(h.target.id){g="#"+h.target.id}else{g="."+h.target.className.replace(/ /g,".")}var f={element_selector:g,clicked_item_dict:JSON.stringify({element_id:h.target.id,element_class:h.target.className,element_data:h.target.dataset,element_text:h.target.textContent,}),};chrome.runtime.sendMessage({action:"sendClick",dataParam:f,})})}else{e._$articlesContainer.empty()}if(d){e._hideContainer(d)}else{e._showContainer()}if(b){e._hideIcon()}render("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+c.bias+".png"),bias:e.mediaBias[c.bias],biasAbbr:c.bias,target_url:c.base_url,publication:c.name,feed_item_id:this.currentPublication.id,},function(f){e._addCurrArticleCB(f)})},_addCurrArticleCB:function(h){var a,c,f;var i=this;var j=function(n){i._$articlesContainer.append(n)};i._$articlesContainer.append(h);if(i.associatedArticles.length){var k=function(n){i._$articlesContainer.append(n);$(window).trigger("resize.show-or-hide")};f=true;c=[];j=[];a="../html/article.html";var l=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-prev">');l.append('<span class="spectrum-icon-prev" aria-hidden="true"></span>');var g=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-next">');g.append('<span class="spectrum-icon-next" aria-hidden="true"></span>');i._$articlesContainer.append(l);l.hide();i._$articlesContainer.append(g);i.associatedArticles.forEach(function(p){var n=i.mediaBias[p.publication_bias];var q=new Date(p.publication_date);var o=p.image_url||p.publication_logo;if(location.host==="www.nytimes.com"){o=p.publication_logo.replace(/^http:/,"https:")}c.push({imageUrl:o,feed_item_id:(i.currentArticle&&i.currentArticle.id)||"",association_id:p.association_id,source:p.publication_name,headLine:p.title,target_url:p.url,more_text:n,bias:p.publication_bias,publication_date:monthNames[q.getMonth()]+" "+q.getDate(),});j.push(k)});var b;$(window).off("resize.show-or-hide").on("resize.show-or-hide",function(){m();setTimeout(function(){if(b){var q,s=0,r=0;var n=b.filter(function(){var v=e(this);var u=$(this).is(":visible");if(q===undefined&&u&&v){q=d(this)}if(!v&&u){s++}if(v&&u){r++}return !u});if(s){g.show()}else{g.hide()}if(r<q){var p=q-r;var t=n.length;for(var o=t;o>t-p;o--){$(n[o-1]).show()}if(t===p){l.hide()}}}},100)});this._$articlesContainer.off("click.show-or-hide").on("click.show-or-hide","a.spectrum-carousel-control",function(t){var o=$(t.currentTarget),n=o.hasClass("spectrum-carousel-prev"),s,p;m();var r=b.filter(function(){var w=e(this);var v=!$(this).is(":visible");if(w&&!v&&!s){s=d(this)}if(n){if(v){if(p===undefined){p=1}else{p++}}return v}if(w){p=0}else{if($.isNumeric(p)){p++}}return w});if(p<=s){o.hide()}if(n){var u=r.length;for(var q=u;q>u-s;q--){$(r[q-1]).show()}g.show()}else{r.hide();l.show()}});function m(){if(!b){var n=i._$articlesContainer.find(".spectrum-article-container");if(i.associatedArticles.length===n.length){b=n}}}function e(n){if(typeof jQuery==="function"&&n instanceof jQuery){n=n[0]}var o=n.getBoundingClientRect();return(o.top>=0&&o.left>=0&&o.top<=(window.innerHeight||document.documentElement.clientHeight)&&o.left<=(window.innerWidth||document.documentElement.clientWidth))}function d(n){return Math.floor((n.parentElement.clientWidth-170)/n.clientWidth)}}else{a="../html/unknown.html";c={imageUrl:chrome.extension.getURL("../images/unknown.png"),currentURL:i.currentURL,location:encodeURIComponent(i.location.href),currentVersion:currentVersion,feed_item_id:(i.currentArticle&&i.currentArticle.id)||"",}}render(a,c,j,f)},};