var associationApiUrl="https://spectrum-backend.herokuapp.com/feeds/associations";var monthNames=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];function processValue(d,e){if(!d){return undefined}if(!d||!d.dateSaved){return d}var c=1000*60*24*7;var a=true;var b=new Date(d.dateSaved);if(e){a=new Date(e)<b}if(a&&new Date()-b<c){return d.data}return null}function getLocalStorage(b,a,c){chrome.storage.sync.get(b,function(d){for(var e in d){if(d.hasOwnProperty(e)){d[e]=processValue(d[e],c)}}if(a){return a(d)}else{return true}})}function setLocalStorage(d,b,e){var a={};for(var c in d){if(d.hasOwnProperty(c)){if(e){a[c]={dateSaved:new Date().toString(),data:d[c],}}else{a[c]=d[c]}}}chrome.storage.sync.set(a,function(){if(b){b()}return true})}function cleanUrl(a){return a.split(".").slice(-2).join(".")}function logError(c,b,a,d){console.log(c);console.log("req",b);console.log("textstatus",a);console.log("errorthrown",d)}function render(a,c,e,d){a=chrome.extension.getURL(a);c=c||{};var b;$.ajax({url:a,type:"GET",}).fail(function(g,f,h){logError("Failed to get template: "+a,g,f,h)}).done(function(g){var f=Handlebars.compile(g);if(d){c.forEach(function(h,j){b=f(h);e[j]($(b))})}else{b=f(c);e($(b))}})}var spectrum={init:function(a,c,b){var d=this;d.publications=c;d.mediaBias=b;getLocalStorage(["hidden"],function(e){d.isNotClosed=e.hidden!=="spectrum-close";if(d.isNotClosed){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",})}else{chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",})}var f=cleanUrl(a.hostname);var g=a.origin+"/"===a.href||a.origin===a.href;d.currentPublication=d.publications[f];if(d.currentPublication&&!g){d.getAssociations()}});return this},getAssociations:function(){var b=this;var a=encodeURIComponent(location.href.split("?")[0]);$.ajax({url:associationApiUrl+"?url="+a,type:"GET",}).fail(function(d,c,e){logError("Failed to get associations",d,c,e)}).done(function(c){b.currentArticle=c;if(c){if(b.isNotClosed){if(b._$container){b._addContainerCb(undefined,c)}else{b.showArticles(c)}}}})},_hideIcon:function(){this._$container.addClass("spectrum-no-button")},_showIcon:function(){this._$container.removeClass("spectrum-no-button")},_showContainer:function(){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",});this.isNotClosed=true;if(this._$articleBorder){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")}},_hideContainer:function(d){var c=this._$container.find("#spectrum-current-publication-icon");var f;var b=d==="spectrum-minimize";var e=b?"spectrum-close":"spectrum-minimize";var a=this.currentPublication.fields.bias;e+=" spectrum-not-minimize";if(d==="spectrum-close"){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",});this.isNotClosed=false}if(b&&!c.attr("src")){f=chrome.extension.getURL("../images/icon-"+a+".png");c.attr("src",f)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(d);this._$container.removeClass(e)},showArticles:function(a){render("../html/main.html",undefined,function(b){this._addContainerCb(b,a)}.bind(this))},_addContainerCb:function(a,b){var c=this.currentPublication.fields;var d=this;getLocalStorage(["hidden","hiddenIcon"],function(e){var g=e.hidden;var f=e.hiddenIcon;if(a){d._$container=a;d._$articlesContainer=a.find("#spectrum-articles-container");d._$articleBorder=a.find("#spectrum-articles-container-top-border");$("body").append(a);if(g===null){d._showContainer()}else{d._hideContainer("spectrum-minimize")}d._$container.on("click.spectrumHide",".spectrum-hide-panel",function(i){var h=i.target.dataset.hideType;setLocalStorage({hidden:h});d._hideContainer(h)});d._$container.on("click.spectrumExpand",".spectrum-expand-icon",function(){setLocalStorage({hidden:null});d._showContainer()})}else{d._$articlesContainer.empty()}if(g){d._hideContainer(g)}else{d._showContainer()}if(f){d._hideIcon()}render("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+c.bias+".png"),bias:d.mediaBias[c.bias],biasAbbr:c.bias,target_url:c.base_url,publication:c.name,},function(h){d._addCurrArticleCB(h,b)})})},_addCurrArticleCB:function(h,l){var a,c,f;var i=this;var j=function(o){i._$articlesContainer.append(o)};i._$articlesContainer.append(h);if(l.length){var k=function(o){i._$articlesContainer.append(o);$(window).trigger("resize.show-or-hide")};f=true;c=[];j=[];a="../html/article.html";var m=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-prev">');m.append('<span class="spectrum-icon-prev" aria-hidden="true"></span>');var g=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-next">');g.append('<span class="spectrum-icon-next" aria-hidden="true"></span>');i._$articlesContainer.append(m);m.hide();i._$articlesContainer.append(g);l.forEach(function(q){var o=i.mediaBias[q.publication_bias];var r=new Date(q.publication_date);var p=q.image_url||q.publication_logo;if(location.host==="www.nytimes.com"){p=q.publication_logo.replace(/^http:/,"https:")}c.push({imageUrl:p,source:q.publication_name,headLine:q.title,target_url:q.url,more_text:o,bias:q.publication_bias,publication_date:monthNames[r.getMonth()]+" "+r.getDate(),});j.push(k)});var b;$(window).off("resize.show-or-hide").on("resize.show-or-hide",function(){n();setTimeout(function(){if(b){var r,t=0,s=0;var o=b.filter(function(){var w=e(this);var v=$(this).is(":visible");if(r===undefined&&v&&w){r=d(this)}if(!w&&v){t++}if(w&&v){s++}return !v});if(t){g.show()}else{g.hide()}if(s<r){var q=r-s;var u=o.length;for(var p=u;p>u-q;p--){$(o[p-1]).show()}if(u===q){m.hide()}}}},100)});this._$articlesContainer.off("click.show-or-hide").on("click.show-or-hide","a.spectrum-carousel-control",function(u){var p=$(u.currentTarget),o=p.hasClass("spectrum-carousel-prev"),t,q;n();var s=b.filter(function(){var x=e(this);var w=!$(this).is(":visible");if(x&&!w&&!t){t=d(this)}if(o){if(w){if(q===undefined){q=1}else{q++}}return w}if(x){q=0}else{if($.isNumeric(q)){q++}}return x});if(q<=t){p.hide()}if(o){var v=s.length;for(var r=v;r>v-t;r--){$(s[r-1]).show()}g.show()}else{s.hide();m.show()}});function n(){if(!b){var o=i._$articlesContainer.find(".spectrum-article-container");if(l.length===o.length){b=o}}}function e(o){if(typeof jQuery==="function"&&o instanceof jQuery){o=o[0]}var p=o.getBoundingClientRect();return(p.top>=0&&p.left>=0&&p.top<=(window.innerHeight||document.documentElement.clientHeight)&&p.left<=(window.innerWidth||document.documentElement.clientWidth))}function d(o){return Math.floor((o.parentElement.clientWidth-170)/o.clientWidth)}}else{a="../html/unknown.html";c={imageUrl:chrome.extension.getURL("../images/unknown.png"),}}render(a,c,j,f)},};