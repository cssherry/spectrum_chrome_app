var associationApiUrl="https://spectrum-backend.herokuapp.com/feeds/associations";var clickURL="https://spectrum-backend.herokuapp.com/feeds/click";var monthNames=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];function processValue(d,e){if(!d){return undefined}if(!d||!d.dateSaved){return d}var c=1000*60*24*7;var a=true;var b=new Date(d.dateSaved);if(e){a=new Date(e)<b}if(a&&new Date()-b<c){return d.data}return null}function getLocalStorage(b,a,c){chrome.storage.sync.get(b,function(d){for(var e in d){if(d.hasOwnProperty(e)){d[e]=processValue(d[e],c)}}if(a){return a(d)}else{return true}})}function setLocalStorage(d,b,e){var a={};for(var c in d){if(d.hasOwnProperty(c)){if(e){a[c]={dateSaved:new Date().toString(),data:d[c],}}else{a[c]=d[c]}}}chrome.storage.sync.set(a,function(){if(b){b()}return true})}function cleanUrl(a){return a.split(".").slice(-2).join(".")}function logError(c,b,a,d){console.log(c);console.log("req",b);console.log("textstatus",a);console.log("errorthrown",d)}function render(a,c,e,d){a=chrome.extension.getURL(a);c=c||{};var b;$.ajax({url:a,type:"GET",}).fail(function(g,f,h){logError("Failed to get template: "+a,g,f,h)}).done(function(g){var f=Handlebars.compile(g);if(d){c.forEach(function(h,j){b=f(h);e[j]($(b))})}else{b=f(c);e($(b))}})}var spectrum={init:function(a,c,b){var d=this;d.location=a;d.publications=c;d.mediaBias=b;getLocalStorage(["hidden","unique_id","username","is_internal_user"],function(e){d.isNotClosed=e.hidden!=="spectrum-close";d.unique_id=e.unique_id;d.username=e.username;d.is_internal_user=e.is_internal_user;if(d.isNotClosed){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",})}else{chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",})}var f=cleanUrl(a.hostname);var g=a.origin+"/"===a.href||a.origin===a.href;d.currentPublication=d.publications[f];if(d.currentPublication&&!g){d.getAssociations()}});return this},getAssociations:function(){var b=this;b.currentURL=location.href.split("?")[0];var a={url:b.currentURL,unique_id:b.unique_id,username:b.username,is_internal_user:b.is_internal_user,};$.ajax({url:associationApiUrl,data:a,type:"POST",}).fail(function(d,c,e){logError("Failed to get associations",d,c,e)}).done(function(c){b.currentArticle=c;if(c){if(b.isNotClosed){if(b._$container){b._addContainerCb(undefined,c)}else{b.showArticles(c)}}}})},_hideIcon:function(){this._$container.addClass("spectrum-no-button")},_showIcon:function(){this._$container.removeClass("spectrum-no-button")},_showContainer:function(){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon.png",});this.isNotClosed=true;if(this._$articleBorder){this._$articleBorder.addClass("spectrum-hide-panel");this._$articleBorder.removeClass("spectrum-expand-icon");this._$container.removeClass("spectrum-close spectrum-minimize");this._$container.addClass("spectrum-not-minimize")}},_hideContainer:function(d){var c=this._$container.find("#spectrum-current-publication-icon");var f;var b=d==="spectrum-minimize";var e=b?"spectrum-close":"spectrum-minimize";var a=this.currentPublication.fields.bias;e+=" spectrum-not-minimize";if(d==="spectrum-close"){chrome.runtime.sendMessage({action:"setIcon",url:"../images/icon-inactive.png",});this.isNotClosed=false}if(b&&!c.attr("src")){f=chrome.extension.getURL("../images/icon-"+a+".png");c.attr("src",f)}this._$articleBorder.addClass("spectrum-expand-icon");this._$articleBorder.removeClass("spectrum-hide-panel");this._$container.addClass(d);this._$container.removeClass(e)},showArticles:function(a){render("../html/main.html",undefined,function(b){this._addContainerCb(b,a)}.bind(this))},_addContainerCb:function(a,b){var c=this.currentPublication.fields;var d=this;getLocalStorage(["hidden","hiddenIcon","unique_id"],function(e){var g=e.hidden;var f=e.hiddenIcon;if(a){d._$container=a;d._$articlesContainer=a.find("#spectrum-articles-container");d._$articleBorder=a.find("#spectrum-articles-container-top-border");$("body").append(a);if(g===null){d._showContainer()}else{d._hideContainer("spectrum-minimize")}d._$container.on("click.spectrumHide",".spectrum-hide-panel",function(i){var h=i.target.dataset.hideType;setLocalStorage({hidden:h});d._hideContainer(h)});d._$container.on("click.spectrumExpand",".spectrum-expand-icon",function(){setLocalStorage({hidden:null});d._showContainer()});d._$container.on("click.sendClick",function(j){var i;j.stopPropagation();if(j.target.id){i="#"+j.target.id}else{i="."+j.target.className.replace(/ /g,".")}var h={element_selector:i,clicked_item_dict:JSON.stringify({element_id:j.target.id,element_class:j.target.className,element_data:j.target.dataset,element_text:j.target.textContent,}),clicked_version:chrome.runtime.getManifest().version,unique_id:e.unique_id,};$.ajax({url:clickURL,data:h,type:"POST",}).fail(function(l,k,m){console.log("Failed to save click");console.log("req",l);console.log("textstatus",k);console.log("errorthrown",m)}).done(function(){console.log("Successfully saved click")})})}else{d._$articlesContainer.empty()}if(g){d._hideContainer(g)}else{d._showContainer()}if(f){d._hideIcon()}render("../html/publication_detail.html",{imageUrl:chrome.extension.getURL("../images/dial-"+c.bias+".png"),bias:d.mediaBias[c.bias],biasAbbr:c.bias,target_url:c.base_url,publication:c.name,},function(h){d._addCurrArticleCB(h,b)})})},_addCurrArticleCB:function(i,m){var a,d,g;var j=this;var k=function(q){j._$articlesContainer.append(q)};j._$articlesContainer.append(i);if(m.length){var l=function(q){j._$articlesContainer.append(q);$(window).trigger("resize.show-or-hide")};g=true;d=[];k=[];a="../html/article.html";var o=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-prev">');o.append('<span class="spectrum-icon-prev" aria-hidden="true"></span>');var h=$('<a role="button" class="spectrum-carousel-control spectrum-carousel-next">');h.append('<span class="spectrum-icon-next" aria-hidden="true"></span>');j._$articlesContainer.append(o);o.hide();j._$articlesContainer.append(h);m.forEach(function(s){var q=j.mediaBias[s.publication_bias];var t=new Date(s.publication_date);var r=s.image_url||s.publication_logo;if(location.host==="www.nytimes.com"){r=s.publication_logo.replace(/^http:/,"https:")}d.push({imageUrl:r,source:s.publication_name,headLine:s.title,target_url:s.url,more_text:q,bias:s.publication_bias,publication_date:monthNames[t.getMonth()]+" "+t.getDate(),});k.push(l)});var c;$(window).off("resize.show-or-hide").on("resize.show-or-hide",function(){p();setTimeout(function(){if(c){var t,v=0,u=0;var q=c.filter(function(){var y=f(this);var x=$(this).is(":visible");if(t===undefined&&x&&y){t=e(this)}if(!y&&x){v++}if(y&&x){u++}return !x});if(v){h.show()}else{h.hide()}if(u<t){var s=t-u;var w=q.length;for(var r=w;r>w-s;r--){$(q[r-1]).show()}if(w===s){o.hide()}}}},100)});this._$articlesContainer.off("click.show-or-hide").on("click.show-or-hide","a.spectrum-carousel-control",function(w){var r=$(w.currentTarget),q=r.hasClass("spectrum-carousel-prev"),v,s;p();var u=c.filter(function(){var z=f(this);var y=!$(this).is(":visible");if(z&&!y&&!v){v=e(this)}if(q){if(y){if(s===undefined){s=1}else{s++}}return y}if(z){s=0}else{if($.isNumeric(s)){s++}}return z});if(s<=v){r.hide()}if(q){var x=u.length;for(var t=x;t>x-v;t--){$(u[t-1]).show()}h.show()}else{u.hide();o.show()}});function p(){if(!c){var q=j._$articlesContainer.find(".spectrum-article-container");if(m.length===q.length){c=q}}}function f(q){if(typeof jQuery==="function"&&q instanceof jQuery){q=q[0]}var r=q.getBoundingClientRect();return(r.top>=0&&r.left>=0&&r.top<=(window.innerHeight||document.documentElement.clientHeight)&&r.left<=(window.innerWidth||document.documentElement.clientWidth))}function e(q){return Math.floor((q.parentElement.clientWidth-170)/q.clientWidth)}}else{var b=chrome.runtime.getManifest();var n=b.version;a="../html/unknown.html";d={imageUrl:chrome.extension.getURL("../images/unknown.png"),currentURL:j.currentURL,location:encodeURIComponent(j.location.href),currentVersion:n,}}render(a,d,k,g)},};